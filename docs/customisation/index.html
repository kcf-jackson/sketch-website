<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/sketch-website/blog/rss.xml" title="Sketch Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/sketch-website/blog/atom.xml" title="Sketch Blog Atom Feed"><title data-react-helmet="true">Customisation | Sketch</title><meta data-react-helmet="true" property="og:url" content="https://kcf-jackson.github.io/sketch-website/docs/customisation"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Customisation | Sketch"><meta data-react-helmet="true" name="description" content="A major change that has occurred as the package reaches 1.0.0 is that every part of the transpiler becomes configurable. In this article, we discuss how one could create custom rewriting rules and deparsers for specific use."><meta data-react-helmet="true" property="og:description" content="A major change that has occurred as the package reaches 1.0.0 is that every part of the transpiler becomes configurable. In this article, we discuss how one could create custom rewriting rules and deparsers for specific use."><link data-react-helmet="true" rel="shortcut icon" href="/sketch-website/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kcf-jackson.github.io/sketch-website/docs/customisation"><link data-react-helmet="true" rel="alternate" href="https://kcf-jackson.github.io/sketch-website/docs/customisation" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kcf-jackson.github.io/sketch-website/docs/customisation" hreflang="x-default"><link rel="stylesheet" href="/sketch-website/assets/css/styles.8ccdf222.css">
<link rel="preload" href="/sketch-website/assets/js/styles.8e47b7d9.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/runtime~main.90ccf38e.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/main.2a9064b4.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/1.601f8a21.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/2.f3d55e96.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/96.3cd994a1.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/98.96910ac0.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/935f2afb.ac846fd7.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/17896441.67a700c2.js" as="script">
<link rel="preload" href="/sketch-website/assets/js/d1ee4b01.b966c38b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/sketch-website/"><strong class="navbar__title">Sketch</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/sketch-website/blog/">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/sketch-website/docs/">Docs</a><a class="navbar__item navbar__link" href="/sketch-website/tutorial/">Tutorial</a><a class="navbar__item navbar__link" href="/sketch-website/showcase/">Showcase</a><a class="navbar__item navbar__link" href="/sketch-website/api/">API</a><a href="https://github.com/kcf-jackson/sketch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/sketch-website/"><strong class="navbar__title">Sketch</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/sketch-website/blog/">News</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/sketch-website/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/sketch-website/tutorial/">Tutorial</a></li><li class="menu__list-item"><a class="menu__link" href="/sketch-website/showcase/">Showcase</a></li><li class="menu__list-item"><a class="menu__link" href="/sketch-website/api/">API</a></li><li class="menu__list-item"><a href="https://github.com/kcf-jackson/sketch" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/manage_assets_and_deployment">Managing assets and Deployment</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Developing JavaScript in R</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/r-to-js-transpilation">Transpiling R to JavaScript</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sketch-website/docs/pitfalls">Pitfalls</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/guides">JavaScript / CSS libraries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/dom">The DOM module</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/R6-OOP">Object-Oriented Programming</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/websocket">WebSocket</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/testing">Testing</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/sketch-website/docs/customisation">Customisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/usage_with_Rmarkdown">Usage with R Markdown documents</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sketch-website/docs/usage_with_shiny">Usage with Shiny</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/sketch-website/docs/about">About</a></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Customisation</h1></header><div class="markdown"><p>A major change that has occurred as the package reaches 1.0.0 is that every part of the transpiler becomes configurable. In this article, we discuss how one could create custom rewriting rules and deparsers for specific use.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="custom-rewriting-rules"></a>Custom rewriting rules<a class="hash-link" href="#custom-rewriting-rules" title="Direct link to heading">#</a></h2><p>To create a rewriting rule, we use the <code>make_rule</code> function. It takes two strings and returns a function that rewrites the first string into the second string appeared in a language object.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">library(sketch)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_1 &lt;- make_rule(&quot;Cpp&quot;, &quot;JS&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## Rule: Rewrite &#x27;Cpp&#x27; to &#x27;JS&#x27;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## function (x) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## subst(x, pattern = from, replacement = to)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## &lt;bytecode: 0x7fa185179de8&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## &lt;environment: 0x7fa18517dfa8&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">expr &lt;- parse_expr(&quot;R + Cpp&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">expr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## R + Cpp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_1(expr)  # Works, but not preferred</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## R + JS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rewrite(expr, list(rule_1))  # preferred</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## R + JS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_2 &lt;- make_rule(&quot;R&quot;, &quot;Rust&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rewrite(expr, list(rule_1, rule_2))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## Rust + JS</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>A custom rewriter is usually needed when one wants to do arithmetic of a special class of objects offered by some JavaScript library. For example, in the case of <a href="https://mathjs.org/" target="_blank" rel="noopener noreferrer"><strong>math.js</strong></a>, addition is expected to be carried out as <code>math.add(x, y)</code> to allow for adding together different types of objects (like vectors and matrices). In such case, we would define the rule as follows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_addition &lt;- make_rule(&quot;+&quot;, &quot;math.add&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rule_addition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## Rule: Rewrite &#x27;+&#x27; to &#x27;math.add&#x27;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## function (x) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## subst(x, pattern = from, replacement = to)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## &lt;bytecode: 0x7fa185179de8&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## &lt;environment: 0x7fa18493f3f8&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Once the rule is created, it can be passed to the transpiler using the <code>rules</code> argument. Specifically,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">compile_exprs(&quot;1 + 2&quot;, rules = list(rule_addition))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## [1] &quot;math.add(1, 2)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Here is an example with <a href="https://www.tensorflow.org/js/" target="_blank" rel="noopener noreferrer"><strong>tensorflow.js</strong></a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tf_rules &lt;- list(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    make_rule(&quot;+&quot;, &quot;tf.add&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    make_rule(&quot;-&quot;, &quot;tf.subtract&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    make_rule(&quot;*&quot;, &quot;tf.multiply&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    make_rule(&quot;/&quot;, &quot;tf.divide&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    make_rule(&quot;%*%&quot;, &quot;tf.matmul&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Now your R expression will transpile to JavaScript using tensorflow&#x27;s API</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">compile_exprs(&quot;(A + B) %*% C&quot;, rules = tf_rules)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## [1] &quot;tf.matmul((tf.add(A, B)), C)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="custom-deparsers"></a>Custom deparsers<a class="hash-link" href="#custom-deparsers" title="Direct link to heading">#</a></h2><p>A custom deparser is needed when there is certain construct that cannot be expressed as a simple rewriting rule. For example, consider the for-loop, in R, it looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (i in x) {...}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>and the corresponding version in JavaScript is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (let i of x) {...}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In such case, the transpilation cannot be done with a simple rewriting rule, and a custom deparser is needed. To create a deparser, two functions are needed: a predicate function that recognises the function-call trigger and a deparse function that performs the transpilation.</p><p>The predicate function must take an “expression” returned by <code>parse_expr</code> (imported from <code>rlang::parse_expr</code>) and return a logical vector of length one.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">is_for &lt;- function(x) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rlang::is_call(x, name = &quot;for&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Unit test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">expr_1 &lt;- parse_expr(&quot;for (i in x) { print(i) }&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">is_for(expr_1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## [1] TRUE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">expr_2 &lt;- parse_expr(&quot;foo(x, y)&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">is_for(expr_2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## [1] FALSE</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The deparse function takes the same input as the predicate function and returns a character string. Note that <code>...</code> must be provided to stay consistent with other deparsers provided by this package. For illustration purposes, we capitalise “of” to distinguish the custom deparser with the one provided by the package.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">collapse &lt;- function(x, s = &quot;\n&quot;) paste(x, collapse = s)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deparse_for &lt;- function(ast, ...) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Turn the symbol into strings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    symbol_str &lt;- purrr::map_chr(ast, deparse1)    # Note 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Rearrange them in the desired form</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sprintf(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;%s (let %s OF %s) %s&quot;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[1],  # for</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[2],  # i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[3],  # x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        collapse(symbol_str[4])   # body</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Unit test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">expr_1 &lt;- parse_expr(&quot;for (i in x) { print(i) }&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deparse_for(expr_1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## [1] &quot;for (let i OF x) {     print(i) }&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To integrate your custom deparser into the “master” deparser provided by this package, <code>deparse_js</code>, first replace the <code>deparse1</code> call in the line marked “Note 1” by <code>deparse_js</code>, and combine the predicate function and the deparse function with <code>make_deparser</code>, then add your deparser to any of the existing lists of deparsers, i.e. <code>basic_deparsers()</code> / <code>default_deparsers()</code> (or you can build your list from scratch too). Here is the full listing of the resulting code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly r"><div tabindex="0" class="prism-code language-r codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Step 1 (see updates on line 4)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deparse_for &lt;- function(ast, ...) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Turn the symbol into strings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    symbol_str &lt;- purrr::map_chr(ast, deparse_js, ...)   # **UPDATED**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Rearrange them in the desired form</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sprintf(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;%s (let %s OF %s) %s&quot;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[1],  # for</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[2],  # i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        symbol_str[3],  # x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        collapse(symbol_str[4])   # body</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Step 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">my_deparser &lt;- make_deparser(is_for, deparse_for)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Step 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">customised_deparsers &lt;- c(list(my_deparser), default_deparsers())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Remark: In most cases, you want your custom deparser to have a higher precedence </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># than the package&#x27;s ones. So it is added to the front rather than to the end.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Unit test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat(compile_exprs(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;for (i in 1:10) { print(i) }&quot;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deparsers = customised_deparsers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## for (let i OF R.seq(1, 10)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##     R.print(i)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">## }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/kcf-jackson/sketch-website/edit/master/docs/customisation.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/sketch-website/docs/testing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Testing sketch application</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/sketch-website/docs/usage_with_Rmarkdown"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Usage with R Markdown documents »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#custom-rewriting-rules" class="table-of-contents__link">Custom rewriting rules</a></li><li><a href="#custom-deparsers" class="table-of-contents__link">Custom deparsers</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/sketch-website/docs/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/sketch-website/docs/guides">Guides</a></li><li class="footer__item"><a class="footer__link-item" href="/sketch-website/api/">API</a></li><li class="footer__item"><a class="footer__link-item" href="/sketch-website/docs/about">About</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/sketch-website/tutorial/">Tutorial</a></li><li class="footer__item"><a class="footer__link-item" href="/sketch-website/showcase/">Showcase</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/sketch-website/blog">News</a></li><li class="footer__item"><a href="https://github.com/kcf-jackson/sketch" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020-2021 Chun Fung Kwok, Kate Saunders | Apache-2.0 Licensed | Built with Docusaurus</div></div></div></footer></div>
<script src="/sketch-website/assets/js/styles.8e47b7d9.js"></script>
<script src="/sketch-website/assets/js/runtime~main.90ccf38e.js"></script>
<script src="/sketch-website/assets/js/main.2a9064b4.js"></script>
<script src="/sketch-website/assets/js/1.601f8a21.js"></script>
<script src="/sketch-website/assets/js/2.f3d55e96.js"></script>
<script src="/sketch-website/assets/js/96.3cd994a1.js"></script>
<script src="/sketch-website/assets/js/98.96910ac0.js"></script>
<script src="/sketch-website/assets/js/935f2afb.ac846fd7.js"></script>
<script src="/sketch-website/assets/js/17896441.67a700c2.js"></script>
<script src="/sketch-website/assets/js/d1ee4b01.b966c38b.js"></script>
</body>
</html>